{% extends "base.html" %}
{% block title %}SSL Check{% endblock %}
{% block content %}
<div class="card-tool">
    <div class="tool-header">
        <h1 class="tool-title">✅ SSL Check</h1>
        <p class="tool-description">Verifica el certificado SSL de un dominio</p>
    </div>
    <div class="input-group-modern">
        <input type="text" id="hostnameInput" placeholder="Ejemplo: google.com" onkeypress="if(event.key==='Enter') check()">
        <button onclick="check()" class="btn-gradient"><i class="bi bi-search"></i> Verificar</button>
    </div>
    <div id="loader" class="loader-container"><div class="spinner"></div><p style="color: var(--text-secondary);">Verificando SSL...</p></div>
    <div id="error" class="alert-modern alert-error"></div>
    <div id="results" class="alert-modern alert-success"></div>
</div>
<script>
async function check() {
    const host = document.getElementById('hostnameInput').value.trim();
    const loader = document.getElementById('loader');
    const errorDiv = document.getElementById('error');
    const resultsDiv = document.getElementById('results');
    if (!host) { errorDiv.innerHTML = '<strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> Ingresa un dominio'; errorDiv.classList.add('active'); return; }
    loader.classList.add('active'); errorDiv.classList.remove('active'); resultsDiv.classList.remove('active');
    try {
        const fd = new FormData(); fd.append('hostname', host);
        const r = await fetch('/api/ssl-check', {method: 'POST', body: fd});
        const d = await r.json();
        if (d.success) {
            const validUntil = new Date(d.data.valid_until);
            const now = new Date();
            const days = Math.ceil((validUntil - now) / (1000*60*60*24));
            let badge = days < 0 ? '<span class="badge-modern badge-danger">Expirado hace ' + (-days) + ' días</span>' : days < 30 ? '<span class="badge-modern badge-warning">Expira en ' + days + ' días</span>' : '<span class="badge-modern badge-success">Válido ' + days + ' días más</span>';
            let h = '<h4><i class="bi bi-shield-check"></i> SSL de <code>' + host + '</code></h4><table class="results-table"><tbody><tr><td><strong>Emitido para</strong></td><td><code>' + (d.data.subject.commonName || 'N/A') + '</code></td></tr><tr><td><strong>Emitido por</strong></td><td>' + (d.data.issuer.commonName || 'N/A') + '</td></tr><tr><td><strong>Estado</strong></td><td>' + badge + '</td></tr><tr><td><strong>Válido desde</strong></td><td>' + new Date(d.data.valid_from).toLocaleString('es-ES') + '</td></tr><tr><td><strong>Válido hasta</strong></td><td>' + validUntil.toLocaleString('es-ES') + '</td></tr></tbody></table><h5 style="margin-top:25px"><i class="bi bi-list-ul"></i> SANs</h5><div style="display:flex;flex-wrap:wrap;gap:8px">';
            d.data.subject_alt_names.forEach(n => h += '<span class="badge-modern badge-info">' + n + '</span>');
            h += '</div>';
            resultsDiv.innerHTML = h; resultsDiv.classList.add('active');
        } else { errorDiv.innerHTML = '<strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> ' + d.error; errorDiv.classList.add('active'); }
    } catch (e) { errorDiv.innerHTML = '<strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> Conexión fallida'; errorDiv.classList.add('active'); }
    finally { loader.classList.remove('active'); }
}
</script>
{% endblock %}
