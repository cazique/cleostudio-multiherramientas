{% extends "base.html" %}
{% block title %}Dividir PDF{% endblock %}

{% block extra_styles %}
.tool-container {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.form-label {
    font-weight: 600;
    color: #495057;
}
.btn-submit {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 12px 20px;
    font-weight: 600;
    transition: all 0.3s;
}
.btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    color: white;
}
#result-container {
    margin-top: 20px;
    display: none;
}
.alert-custom {
    padding: 15px;
    border-radius: 8px;
}
.loader {
    width: 48px;
    height: 48px;
    border: 5px solid #FFF;
    border-bottom-color: #667eea;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
    margin: 20px auto;
}
@keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
{% endblock %}

{% block content %}
<div class="tool-container">
    <div class="text-center mb-4">
        <h2><i class="bi bi-scissors"></i> Dividir PDF</h2>
        <p class="text-muted">Extrae páginas o rangos de un archivo PDF.</p>
    </div>

    <form id="split-form" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="pdf-file" class="form-label">Archivo PDF</label>
            <input type="file" class="form-control" id="pdf-file" name="file" accept=".pdf" required>
        </div>

        <div class="mb-3">
            <label for="pages" class="form-label">Páginas a extraer</label>
            <input type="text" class="form-control" id="pages" name="pages" placeholder="Ej: 1, 3-5, 8" required>
            <div class="form-text">
                Usa comas para separar números y guiones para rangos.
            </div>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-submit">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                Dividir PDF
            </button>
        </div>
    </form>

    <div id="result-container" class="mt-4">
        <div id="error-alert" class="alert alert-danger alert-custom d-none"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('split-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const button = form.querySelector('button[type="submit"]');
    const spinner = button.querySelector('.spinner-border');
    const errorAlert = document.getElementById('error-alert');

    // Reset UI
    button.disabled = true;
    spinner.classList.remove('d-none');
    errorAlert.classList.add('d-none');
    errorAlert.textContent = '';

    const formData = new FormData(form);

    try {
        const response = await fetch('/api/split-pdf', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'dividido.pdf';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch.length > 1) {
                    filename = filenameMatch[1];
                }
            }
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Ocurrió un error desconocido.');
        }

    } catch (error) {
        errorAlert.textContent = `Error: ${error.message}`;
        errorAlert.classList.remove('d-none');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
});
</script>
{% endblock %}